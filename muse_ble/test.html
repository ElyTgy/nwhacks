<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muse 2 BLE Debugger</title>
</head>
<body>
    <h1>Muse 2 Bluetooth Debugger</h1>
    <button id="connectButton">Connect to Muse 2</button>
    <p id="status">Not connected</p>
    <pre id="output"></pre>

    <script>
        async function connectAndListenMuse() {
            try {
                logOutput("ğŸ” Searching for Muse 2...");

                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000fe8d-0000-1000-8000-00805f9b34fb'] // Muse 2 Service UUID
                });

                logOutput(`âœ… Connecting to: ${device.name}`);
                document.getElementById("status").textContent = `Connected to: ${device.name}`;

                const server = await device.gatt.connect();
                logOutput("âœ… Connected to GATT server");

                // Get all services
                const services = await server.getPrimaryServices();
                logOutput(`ğŸ”¹ Found ${services.length} services`);

                for (const service of services) {
                    logOutput(`ğŸ”¹ Service UUID: ${service.uuid}`);

                    // Get all characteristics for this service
                    const characteristics = await service.getCharacteristics();
                    for (const characteristic of characteristics) {
                        logOutput(`  ğŸ”¸ Characteristic UUID: ${characteristic.uuid}`);
                        console.log(`  Properties:`, characteristic.properties);
                        console.log(`Characteristic properties:`, characteristic.properties);

                        // If it's readable, try reading the value
                        if (characteristic.properties.read) {
                            await readCharacteristicValue(characteristic);
                        }

                        // If it supports notifications, subscribe to it
                        if (characteristic.properties.notify) {
                            await subscribeToCharacteristic(characteristic);
                        }
                    }
                }

                logOutput("âœ… Finished listing services and characteristics");

            } catch (error) {
                logOutput(`âŒ Error: ${error}`);
            }
        }

        // ğŸ”¹ Subscribe to characteristic notifications
        async function subscribeToCharacteristic(characteristic) {
            try {
                logOutput(`  ğŸŸ  Subscribing to: ${characteristic.uuid}`);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    logOutput(`  ğŸ”´ Notification from ${characteristic.uuid}: ${formatValue(event.target.value)}`);
                });

                logOutput(`âœ… Successfully subscribed to: ${characteristic.uuid}`);
            } catch (error) {
                logOutput(`âŒ Error subscribing to ${characteristic.uuid}: ${error}`);
            }
        }

        // ğŸ”¹ Read characteristic values
        async function readCharacteristicValue(characteristic) {
            try {
                const value = await characteristic.readValue();
                logOutput(`  ğŸŸ¢ Readable value from ${characteristic.uuid}: ${formatValue(value)}`);
            } catch (error) {
                logOutput(`âŒ Error reading ${characteristic.uuid}: ${error}`);
            }
        }

        // ğŸ”¹ Format incoming BLE data
        function formatValue(value) {
            if (!value) return "N/A";
            const bytes = new Uint8Array(value.buffer);
            return `[${bytes.join(", ")}]`;
        }

        // ğŸ”¹ Function to log messages to the webpage
        function logOutput(message) {
            console.log(message);
            document.getElementById("output").textContent += message + "\n";
        }

        // ğŸ”¹ Attach function to button
        document.getElementById("connectButton").addEventListener("click", connectAndListenMuse);
    </script>
</body>
</html>